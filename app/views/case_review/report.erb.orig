<%= stylesheet_link_tag 'daterangepicker-bs3', 'jquery.dataTables', 'bootstrap-multiselect' %>
<%= javascript_include_tag 'moment.min', 'daterangepicker', 'jquery.dataTables', 'bootstrap-multiselect', 'prettify' %>
<div class="page" style="width:1280px;">
  <div class="pageheader">
    <form role="form">
      <table>
        <tr>
          <td width="100%" height="100%" align="right">
            <table>
              <tr>
                <td style="padding:5px;" align="left">
                  <label>Period</label>
                </td>
                <td style="padding:5px;" align="left">
                  <div id="daterange" class="selectbox" style="background: #fff; cursor: pointer; padding: 2px 5px; border: 1px solid #a9a9a9;border-radius: 4px;width:210px">
                    <i class="glyphicon glyphicon-calendar"></i>
                    <span></span>
                    <b class="caret"></b>
                  </div>
                  <!-- daterange -->
                </td>
              </tr>
            </table>
          </td>
          <td width="6px"></td>
          <td align="center" valign="center" style="border-left:1px #CCCCCC Solid;padding:10px;">
            <table>
              <tbody>
                <tr>
                  <button type="submit" id="btn_viewreport" class="btn btn-success">View Report</button>
                </tr>
              </tbody>
            </table>
          </td>
        </tr>
      </table>
    </form>
		<!--/.form pageheader-->
  </div>
  <!--/.pageheader -->
	<div class="pagecontent">
    <div class="tab-content">
			<table id="mpa" class="display" cellspacing="0" width="100%"></table>
		</div>
		<!--/.tab-content-->
	</div>
	<!--/.pagecontent-->
</div>
<!--page-->
<script>
	var start_date = '';
	var end_date = '';
	var arr_user = '';
	var data_table;
	var data_set;
	$(document).ready(function() {
    $('#daterange').daterangepicker({
      ranges: {
        'Today': [new Date(), new Date()],
        'Yesterday': [moment().subtract('days', 1), moment().subtract('days', 1)],
        'Last 7 Days': [moment().subtract('days', 6), new Date()],
        'Last 30 Days': [moment().subtract('days', 29), new Date()],
        'This Month': [moment().startOf('month'), moment().endOf('month')],
        'Last Month': [moment().subtract('month', 1).startOf('month'), moment().subtract('month', 1).endOf('month')]
      },
      opens: 'left',
      format: 'YYYY-MM-DD',
      //startDate: '2014-04-08',
      //endDate: '2014-05-07'
    },
		function(start, end) {
			start_date = start.format('YYYYMMDD');
			end_date = end.format('YYYYMMDD');
			console.log(start_date);
      $('#daterange span').html(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));
    });

		function gen_report(){		
			var team = getURLParameter("team");
			$.post("/case_review/get_case_review_report", {"start_date": start_date, "end_date": end_date, "team": team}, function(data, status) {
				data_set = JSON.parse(data);
				console.log(data_set);
				data_table = $('#mpa').dataTable({
					"bAutoWidth" : false,
					"retrieve" : true,
					"iDisplayLength": 100,
					"data" : data_set,
					"order" : [[1,"desc"]],
					"columns" : [
						{
							"class" : 'details-control',
							"orderable" : false,
							"data" : null,
							"defaultContent" : ''
						},
						{ "title" : "CaseID" },
						{ "title" : "Sev" , "sClass" : "center"},
						{ "title" : "Score"},
						{ "title" : "Owner" },
						{ "title" : "IR template" },
						{ "title" : "Annotation" },
						{ "title" : "Handover template" },
						{ "title" : "Timely update" },
						{ "title" : "Closure template" },
						{ "title" : "Closure consent" },
						{ "title" : "Courtesy" },
						{ "title" : "Wording" },
						{ "title" : "Technical expertise" }
					]
				});
				data_table.fnClearTable(0);
				data_table.fnAddData(data_set);
				data_table.fnDraw();
			});
		}
		function get_current_month() {
			var firstDate = new Date();
			firstDate.setDate(1);
			firstDate.setMonth(firstDate.getMonth() - 0);
			var endDate = new Date(firstDate);
			endDate.setMonth(firstDate.getMonth()+1);
			endDate.setDate(0);
			start_date = firstDate.format("yyyyMMdd");
			end_date = endDate.format("yyyyMMdd");
			return firstDate.format("dd/MM/yyyy") + ' - ' + endDate.format("dd/MM/yyyy");
		}
		$('#daterange span').html(get_current_month());
		$('#btn_viewreport').click(function(e){
			e.preventDefault();
			console.log(data_table);
			//data_table.fnClearTable(0);
			gen_report();
		});
		
		gen_report();
	});
</script>
